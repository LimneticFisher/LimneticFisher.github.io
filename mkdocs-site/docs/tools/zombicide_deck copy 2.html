<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zombicide Ultimate FX</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:ital,wght@1,700&family=Permanent+Marker&family=ZCOOL+QingKe+HuangYou&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* === æ¡Œé¢ç«¯é»˜è®¤å‚æ•° (å¤§å±) === */
            --card-width: 44vh;
            --card-height: 62vh;
            --info-width: 360px;
            --font-hp: 6rem;
            --font-name: 3rem;
            --font-desc: 1.4rem;
            
            --hazard-yellow: #f1c40f;
            --hazard-black: #111;
            --bg-dark: #050505;
            --stripe-pattern: repeating-linear-gradient(
                45deg,
                var(--hazard-yellow),
                var(--hazard-yellow) 15px,
                var(--hazard-black) 15px,
                var(--hazard-black) 30px
            );

            --color-common: #dcdde1;
            --color-rare: #00a8ff;
            --color-epic: #9c88ff;
            --color-legendary: #ffbe76;
            --color-golden: #fbc531;
        }

        /* === ğŸ“± å¹³æ¿/å°ç¬”è®°æœ¬é€‚é… === */
        @media (max-width: 1200px) {
            :root {
                --card-width: 35vh;
                --card-height: 50vh;
                --info-width: 300px;
                --font-hp: 4.5rem;
                --font-name: 2.2rem;
                --font-desc: 1.1rem;
            }
        }

        /* === ğŸ“± æ‰‹æœº/ç«–å±å¹³æ¿é€‚é… === */
        @media (max-width: 768px) {
            :root {
                --card-width: 60vw; 
                --card-height: 85vw; 
                --info-width: 85vw;  
                --font-hp: 4rem;
                --font-name: 2rem;
                --font-desc: 1rem;
            }
        }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at center, #1e1e1e 0%, #000 80%);
            font-family: 'ZCOOL QingKe HuangYou', sans-serif;
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        .hazard-bar {
            height: 30px; width: 100%;
            background: var(--stripe-pattern);
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            z-index: 100;
        }
        .hazard-bar.top { border-bottom: 4px solid #000; }
        .hazard-bar.bottom { border-top: 4px solid #000; }

        .stage-center {
            flex: 1;
            display: flex; align-items: center; justify-content: center;
            perspective: 1500px; position: relative;
            padding-bottom: 40px;
        }

        /* å…‰çˆ†å±‚ */
        .burst-layer {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 100%; pointer-events: none; z-index: 0;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .burst-core {
            position: absolute; width: 0; height: 0; border-radius: 50%;
            background: radial-gradient(circle, #fff 0%, var(--rarity-color) 60%, transparent 100%);
            opacity: 0; mix-blend-mode: screen; filter: blur(20px);
        }
        .burst-glow {
            position: absolute; width: 0; height: 0; border-radius: 50%;
            background: var(--rarity-color); opacity: 0; filter: blur(80px); mix-blend-mode: screen;
        }
        .burst-ring {
            position: absolute; width: 0; height: 0; border-radius: 50%;
            border: 4px solid #fff; box-shadow: 0 0 30px var(--rarity-color); opacity: 0;
        }
        .burst-layer.active .burst-core { animation: anim-core 0.8s cubic-bezier(0.1, 0.9, 0.2, 1) forwards; }
        .burst-layer.active .burst-glow { animation: anim-glow 1.2s ease-out forwards; }
        .burst-layer.active .burst-ring { animation: anim-ring 0.6s cubic-bezier(0, 0.9, 0.57, 1) forwards; }
        
        @keyframes anim-core { 0% { width: 0; height: 0; opacity: 1; } 30% { opacity: 1; } 100% { width: 120vmin; height: 120vmin; opacity: 0; } }
        @keyframes anim-glow { 0% { width: 0; height: 0; opacity: 0.8; } 100% { width: 150vmax; height: 150vmax; opacity: 0; } }
        @keyframes anim-ring { 0% { width: 0; height: 0; opacity: 0; border-width: 20px; } 10% { opacity: 1; } 100% { width: 120vmin; height: 120vmin; opacity: 0; border-width: 0px; } }

        /* === äº¤äº’å®¹å™¨ === */
        .interaction-container {
            display: flex; align-items: center; justify-content: center;
            width: var(--card-width); height: var(--card-height);
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative; z-index: 10;
        }

        /* âœ… æ¡Œé¢ç«¯/å¹³æ¿æ‚¬åœå±•å¼€ - ã€å…³é”®ä¿®æ”¹ã€‘ 
           ç§»é™¤äº† :hover é€‰æ‹©å™¨ï¼Œåªè¦æ˜¯ active (ç¿»å¼€) çŠ¶æ€ï¼Œå°±ä¿æŒå±•å¼€å’Œå¯ç‚¹å‡»
        */
        @media (min-width: 769px) {
            .interaction-container.active { 
                /* åªè¦ç¿»å¼€ï¼Œå®½åº¦å°±å˜å®½ï¼Œä¸éœ€è¦é¼ æ ‡æ‚¬åœ */
                width: calc(var(--card-width) + var(--info-width) + 60px); 
            }
            .interaction-container.active .scene { 
                /* åªè¦ç¿»å¼€ï¼Œå¡ç‰Œå°±å·¦ç§» */
                transform: rotate(-3deg) translateX(-60px) scale(1.1); 
            }
            .interaction-container.active .info-panel { 
                /* åªè¦ç¿»å¼€ï¼Œé¢æ¿å°±æ˜¾ç¤ºä¸”å¯ç‚¹å‡» */
                margin-left: 60px; 
                opacity: 1; 
                transform: translateX(0) translateZ(0); 
                pointer-events: auto; /* å…³é”®ï¼šå…è®¸ç‚¹å‡» */
            }
        }

        /* === ğŸ“± æ‰‹æœºç«¯ç‰¹æ®Šå¸ƒå±€ === */
        @media (max-width: 768px) {
            .interaction-container {
                flex-direction: column; 
                height: auto; 
            }
            
            .interaction-container.active .scene {
                transform: scale(0.65) translateY(-20px); 
                margin-bottom: -80px; 
            }
            
            .interaction-container.active .info-panel {
                margin-left: 0; 
                margin-top: 20px;
                opacity: 1; 
                transform: translateY(0); 
                pointer-events: auto; /* å…³é”®ï¼šå…è®¸ç‚¹å‡» */
                position: relative;
                z-index: 100; 
            }
            
            .reshuffle-container {
                top: 105% !important; 
            }
        }

        .scene {
            width: var(--card-width); height: var(--card-height);
            position: relative; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            flex-shrink: 0; 
        }

        /* å¡ç‰Œ */
        .card {
            width: 100%; height: 100%; position: relative;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-style: preserve-3d; cursor: pointer; border-radius: 16px;
        }
        .card.is-flipped { transform: rotateY(180deg); }
        .card.is-empty { cursor: not-allowed; filter: grayscale(100%); opacity: 0.7; }
        
        .card:not(.is-empty)::before {
            content: ''; position: absolute; top: -15px; left: -15px; right: -15px; bottom: -15px;
            background: var(--rarity-color); z-index: -1; filter: blur(20px); opacity: 0;
            transition: opacity 0.5s ease; border-radius: 30px;
        }
        .card:not(.is-flipped):not(.is-empty):hover::before { opacity: 0.4; }
        
        .card[data-rarity="common"] { --rarity-color: var(--color-common); }
        .card[data-rarity="rare"] { --rarity-color: var(--color-rare); }
        .card[data-rarity="epic"] { --rarity-color: var(--color-epic); }
        .card[data-rarity="legendary"] { --rarity-color: var(--color-legendary); }
        .card[data-rarity="golden"] { --rarity-color: var(--color-golden); }
        .card[data-rarity="empty"] { --rarity-color: #555; }

        .card__face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 16px; overflow: hidden;
            border: 4px solid #000; background-color: #000;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8); 
        }
        .card__face--front { 
            background-color: #8E2F39; 
            background-image: url('../images/card_back.png'); 
            background-size: cover; background-position: center; 
            display: flex; align-items: center; justify-content: center;
        }
        .empty-msg {
            display: none; font-size: 1.8rem; color: #fff; text-shadow: 0 0 10px #000;
            transform: rotate(-15deg); border: 4px solid #fff; padding: 10px 20px;
        }
        .card.is-empty .empty-msg { display: block; }

        .card__face--back { transform: rotateY(180deg); display: flex; align-items: center; justify-content: center; position: relative; }

        .sheen-overlay {
            position: absolute; top: 0; left: -150%; width: 100%; height: 100%;
            background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
            transform: skewX(-25deg); pointer-events: none; z-index: 20; mix-blend-mode: overlay;
        }
        .card.is-flipped .sheen-overlay { animation: sheen-anim 0.8s ease-out 0.2s; }
        @keyframes sheen-anim { 0% { left: -150%; opacity: 0; } 50% { opacity: 1; } 100% { left: 150%; opacity: 0; } }

        .hazard-border-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10;
            background: var(--stripe-pattern);
            -webkit-mask: linear-gradient(#fff, #fff) content-box, linear-gradient(#fff, #fff);
            -webkit-mask-composite: xor; mask-composite: exclude;
            padding: 12px; pointer-events: none;
        }
        .card-image-full { width: 100%; height: 100%; object-fit: cover; }

        /* === ä¿¡æ¯æ  === */
        .info-panel {
            width: var(--info-width);
            margin-left: calc(var(--info-width) * -1); /* åˆå§‹éšè—åœ¨å·¦ä¾§ */
            opacity: 0;
            transform: translateX(30px) translateZ(-100px);
            display: flex; flex-direction: column; gap: 20px;
            z-index: 1; transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            
            /* âš ï¸ é»˜è®¤ä¸å¯ç‚¹å‡»ï¼Œä½†åœ¨ active çŠ¶æ€ä¸‹ä¼šå˜ä¸º auto */
            pointer-events: none; 
        }
        
        .info-box {
            position: relative; background: rgba(0,0,0,0.9); padding: 15px 20px;
            color: var(--hazard-yellow); text-align: center;
            border: 4px solid transparent; background-clip: padding-box;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        .info-box::before {
            content: ''; position: absolute; top: -4px; bottom: -4px; left: -4px; right: -4px;
            background: var(--stripe-pattern); z-index: -1; border-radius: 6px;
        }
        
        .info-title-box { display: flex; justify-content: center; align-items: center; min-height: 60px; position: relative; overflow: visible; }
        .info-name { 
            font-family: 'ZCOOL QingKe HuangYou', sans-serif; 
            font-size: var(--font-name); 
            letter-spacing: 2px; text-shadow: 3px 3px 0 #000; 
        }
        .hp-badge {
            position: absolute; top: -40px; right: -20px;
            font-family: 'Permanent Marker', cursive; 
            font-size: var(--font-hp);
            color: #000; -webkit-text-stroke: 3px var(--hazard-yellow);
            filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.6)); transform: rotate(15deg); z-index: 10; pointer-events: none;
        }
        
        .info-desc-box { 
            text-align: left; 
            font-size: var(--font-desc); 
            line-height: 1.5; text-shadow: 2px 2px 0 #000; font-family: 'ZCOOL QingKe HuangYou', sans-serif; 
        }
        .type-tag { 
            display: inline-block; background: var(--hazard-yellow); color: #000; font-family: 'ZCOOL QingKe HuangYou', sans-serif; 
            padding: 4px 10px; border-radius: 4px; margin-bottom: 10px; 
            font-size: 1rem; letter-spacing: 1px; box-shadow: 3px 3px 0 rgba(0,0,0,0.5); transform: rotate(-2deg); text-shadow: none; 
        }
        
        .info-flavor-box {
            font-family: 'Noto Serif SC', serif; font-style: italic; font-weight: 700;
            font-size: 1rem; color: #eee; text-align: left; line-height: 1.6;
            min-height: 60px; display: flex; flex-direction: column; justify-content: space-between;
        }
        .flavor-text { margin-bottom: 10px; opacity: 0.95; text-shadow: 1px 1px 0 #000; }
        
        .card-actions {
            display: flex; align-items: center; justify-content: center; gap: 15px;
            padding-top: 10px; border-top: 2px dashed rgba(255,255,255,0.2);
        }
        .return-btn { cursor: pointer; font-size: 2.2rem; color: var(--hazard-yellow); transition: transform 0.2s; }
        .return-btn:hover { transform: scale(1.2) rotate(-20deg); color: #fff; }
        
        .deck-counter {
            font-family: 'Permanent Marker', cursive; font-size: 1.3rem; color: #fff;
            background: #000; padding: 2px 8px; border-radius: 4px; border: 1px solid var(--hazard-yellow);
            transform: rotate(5deg);
        }

        /* æŒ‰é’®ç»„ä»¶ */
        .action-btn {
            background: #000; color: var(--hazard-yellow); border: 2px solid var(--hazard-yellow);
            padding: 8px; border-radius: 50%; cursor: pointer; opacity: 0.7; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .action-btn:hover { opacity: 1; transform: scale(1.1); box-shadow: 0 0 15px var(--hazard-yellow); }
        .action-btn svg { width: 22px; height: 22px; display: block; }

        .sound-toggle { position: fixed; bottom: 80px; left: 20px; z-index: 200; }
        .sound-off-icon { display: none; }
        .sound-toggle.muted .sound-on-icon { display: none; }
        .sound-toggle.muted .sound-off-icon { display: block; }

        /* æ´—ç‰ŒæŒ‰é’® */
        .reshuffle-container {
            position: absolute; top: 110%; left: 50%; transform: translateX(-50%);
            z-index: 20; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .interaction-container:not(.active) .reshuffle-container { opacity: 1; pointer-events: auto; }
        
        .reshuffle-btn {
            background: var(--hazard-yellow); color: #000; border: none;
            font-family: 'ZCOOL QingKe HuangYou', sans-serif; font-size: 1.3rem;
            padding: 8px 20px; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: transform 0.2s; white-space: nowrap;
        }
        .reshuffle-btn:hover { transform: scale(1.1); color: #fff; background: #d35400; }
        .reshuffle-btn:active { transform: scale(0.95); }

        /* æ‰©å±•åŒ…è¿‡æ»¤å™¨ */
        .filter-wrapper {
            position: fixed; bottom: 40px; right: 15px; z-index: 300;
            display: flex; flex-direction: column; align-items: flex-end;
        }
        .filter-icon {
            width: auto; height: auto; max-width: 80px; max-height: 80px;
            cursor: pointer; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
            transition: transform 0.3s;
        }
        .filter-wrapper:hover .filter-icon { transform: scale(1.1) rotate(-10deg); }
        .filter-menu {
            position: absolute; bottom: 75px; right: 0; width: 180px;
            background: rgba(0,0,0,0.95); border: 2px solid var(--hazard-yellow);
            padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            opacity: 0; visibility: hidden; transform: translateY(20px) scale(0.9);
            transition: all 0.3s;
            background-image: repeating-linear-gradient(45deg, rgba(241,196,15,0.05) 0, rgba(241,196,15,0.05) 10px, transparent 10px, transparent 20px);
        }
        .filter-wrapper:hover .filter-menu { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }
        .menu-title {
            color: var(--hazard-yellow); font-size: 1.1rem; margin-bottom: 8px;
            border-bottom: 1px dashed rgba(241, 196, 15, 0.3); padding-bottom: 4px; text-align: center;
        }
        .filter-item { display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; color: #fff; font-size: 0.95rem; transition: color 0.2s; }
        .filter-item:hover { color: var(--hazard-yellow); }
        .filter-checkbox {
            appearance: none; -webkit-appearance: none; width: 16px; height: 16px;
            border: 2px solid var(--hazard-yellow); background: transparent; margin-right: 8px; position: relative; cursor: pointer;
        }
        .filter-checkbox:checked { background: var(--hazard-yellow); }
        .filter-checkbox:checked::after { content: 'âœ”'; position: absolute; color: #000; font-size: 12px; font-weight: bold; top: -2px; left: 1px; }

    </style>
</head>
<body>

    <div class="hazard-bar top"></div>

    <div class="stage-center">
        <div class="burst-layer" id="burstLayer">
            <div class="burst-glow"></div>
            <div class="burst-core"></div>
            <div class="burst-ring"></div>
        </div>

        <div class="interaction-container" id="interactionWrapper">
            <div class="scene">
                <div class="reshuffle-container">
                    <button class="reshuffle-btn" id="mainReshuffleBtn">ğŸ”„ é‡ç½®ç‰Œå †</button>
                </div>

                <div class="card" id="gameCard" data-rarity="common">
                    <div class="card__face card__face--front">
                        <div class="empty-msg">ç‰Œå †è€—å°½<br>è¯·æ´—ç‰Œ</div>
                    </div>
                    <div class="card__face card__face--back">
                        <div class="hazard-border-overlay"></div>
                        <div class="sheen-overlay"></div>
                        <img id="cardImage" class="card-image-full" src="" alt="Abomination">
                    </div>
                </div>
            </div>

            <div class="info-panel">
                <div class="info-box info-title-box">
                    <div class="info-name" id="infoName">LOADING</div>
                    <div class="hp-badge" id="infoHp">3</div>
                </div>
                <div class="info-box info-desc-box">
                    <div id="infoType" class="type-tag">TYPE</div>
                    <div id="infoAbility">Ability text...</div>
                </div>
                <div class="info-box info-flavor-box">
                    <div class="flavor-text" id="infoFlavor">"Flavor text..."</div>
                    
                    <div class="card-actions">
                        <div class="return-btn" id="returnBtn" title="è¿”å›ç‰Œåº“">â†©</div>
                        <div class="deck-counter" id="deckCounter">0/0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="sound-toggle action-btn" id="soundToggle" title="å¼€å…³è¯­éŸ³">
        <svg class="sound-on-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77zm-4 0h-2.59l-5 5H1v6h1.41l5 5H10v-16z"/></svg>
        <svg class="sound-off-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
    </div>

    <div class="filter-wrapper">
        <div class="filter-menu" id="filterMenu">
            <div class="menu-title">é€‰æ‹©æ‰©å±•åŒ…</div>
        </div>
        <img src="../images/logo.png" class="filter-icon" alt="Expansion Filter">
    </div>

    <div class="hazard-bar bottom"></div>

    <script>
        // ===============================================
        // ğŸ› ï¸ æ•°æ®å½•å…¥åŒº
        // ===============================================
        const deckData = [
            { 
                name: "æµæµªæ†æ¶", hp: "3", type: "æ†æ¶", expansion: "åŸºç¡€",
                image: "../images/Abomination-3.webp", 
                ability: "åœ¨æµæµªè€…æ‰€åœ¨åŒºåŸŸçš„å¹¸å­˜è€…æ— æ³•æ‰§è¡Œæˆ˜æ–—åŠ¨ä½œã€‚", 
                flavor: "â€œæµæµªè€…åœ¨å„æ–¹é¢éƒ½æå…¶æ¶å¿ƒï¼Œç«™åœ¨å®ƒæ—è¾¹ç®€ç›´è®©äººæ— æ³•å¿å—ã€‚â€" 
            },
            { 
                name: "é›¶å·ç—…äºº", hp: "3", type: "æ†æ¶", expansion: "åŸºç¡€",
                image: "../images/Abomination-4.webp", 
                ability: "æ— ç‰¹æ®Šè§„åˆ™ã€‚", 
                flavor: "â€œçœŸçš„æ˜¯ç¬¬ä¸€ä¸ªä¸§å°¸å—ï¼Ÿæ²¡äººèƒ½è¯´å‡ºæ¥ã€‚è¿™å®ƒç¡®å®æŠŠåŒ»é™¢å˜æˆäº†æ„ŸæŸ“çš„å™©æ¢¦ã€‚â€" 
            },
            { 
                name: "è­¦å‘˜", hp: "3", type: "æ†æ¶", expansion: "åŸºç¡€",
                image: "../images/Abomination-1.webp", 
                ability: "è¢«æ”»å‡»æ—¶ï¼Œè­¦å‘˜ä½œä¸ºå…¶æ‰€åœ¨åŒºåŸŸçš„ä¼˜å…ˆç›®æ ‡ã€‚", 
                flavor: "â€œå®ƒæƒ³å¿…æ‰®æ¼”è¿‡å¥½å‡ æ¬¡åè­¦å¯Ÿã€‚â€" 
            },
            { 
                name: "è’é‡æ†æ¶", hp: "3", type: "æ†æ¶", expansion: "åŸºç¡€",
                image: "../images/Abomination-2.webp", 
                ability: "åœ¨è’é‡æ†æ¶æ‰€åœ¨åŒºåŸŸæŠ•æ·ç‡ƒçƒ§ç“¶æ—¶ï¼Œä»…æ€æ­»è’é‡æ†æ¶ã€‚å…¶ä»–è¡ŒåŠ¨è€…ä¸å—å½±å“ã€‚", 
                flavor: "â€œè’é‡æ†æ¶æ˜¯ä¸ªéš¾å¯¹ä»˜çš„ç¡¬èŒ¬ï¼Œéœ€è¦é›†ä¸­ç«åŠ›æ¥è§£å†³ã€‚æˆ‘æ˜¯è¯´å­—é¢æ„æ€ä¸Šçš„â€˜ç«â€™åŠ›ï¼â€" 
            },
            { 
                name: "å¤–æ˜Ÿäºº", hp: "3", type: "æ†æ¶", expansion: "éƒ½å¸‚ä¼ è¯´",
                image: "../images/Abductor.webp", 
                ability: "-å…¶è§†çº¿å¿½ç•¥æš—åŒºå’Œå¤œæ™šè§„åˆ™ã€‚<br>-è¡ŒåŠ¨ç»“æŸåï¼Œä»æ£‹ç›˜ä¸Šç§»é™¤å®ƒè§†çº¿ä¸­çš„ä¸€åå¹¸å­˜è€…ï¼ˆç©å®¶é€‰æ‹©ï¼‰ã€‚åœ¨å…¶ä¸‹ä¸€æ¬¡è¡ŒåŠ¨å¼€å§‹å‰ï¼Œå°†å¹¸å­˜è€…é€å›åŒä¸€åŒºåŸŸã€‚", 
                flavor: "-â€œä½ å·²æ€¥å“­ã€‚â€<br>-â€œæ”¶åˆ°ã€‚â€" 
            },
            { 
                name: "ä¸‹æ°´é“é³„é±¼", hp: "3", type: "æ†æ¶", expansion: "éƒ½å¸‚ä¼ è¯´",
                image: "../images/Sewer-Croc.webp", 
                ability: "-éšæœºé€‰æ‹©ä¸€åå¹¸å­˜è€…ä½œä¸ºçŒç‰©ã€‚<br>-å®ƒåªä¼šæ¥è¿‘å¹¶æ”»å‡»é€‰æ‹©çš„å¹¸å­˜è€…ï¼Œæ— è§†å…¶ä»–å¹²æ‰°ã€‚<br>-è¡ŒåŠ¨ä¸¤æ¬¡ã€‚", 
                flavor: "â€œå½“ç„¶ï¼Œä¸‹æ°´é“é‡Œæœ‰é³„é±¼ã€‚é»‘å¸®åˆ†å­ä¼šè¯´ï¼Œæ²¡æœ‰ä»€ä¹ˆæ¯”é³„é±¼æ›´é€‚åˆå¤„ç†â€œè¯æ®â€äº†ã€‚è¢«æ„ŸæŸ“åï¼Œä¸§å°¸é³„é±¼ä¼šå››å¤„çŒæ€ï¼Œäº«ç”¨ä¸‹ä¸€é¡¿æ–°é²œçš„é£Ÿç‰©ã€‚â€" 
            },
            { 
                name: "å°ä¸‘æ€æ‰‹", hp: "3", type: "æ†æ¶", expansion: "éƒ½å¸‚ä¼ è¯´",
                image: "../images/Killer-Clown.webp", 
                ability: "å¹¸å­˜è€…ä¸èƒ½ä½¿ç”¨ä»–ä»¬é€šè¿‡è‚¾ä¸Šè…ºç´ è·å¾—çš„æœ€æ–°æŠ€èƒ½ï¼ˆä¸é€‚ç”¨äºè“è‰²ç­‰çº§æŠ€èƒ½ï¼‰ã€‚", 
                flavor: "â€œæˆ‘è®°å¾—ä»–ã€‚ä»–æ•´å¤©èº²åœ¨è¡—è§’ï¼Œç¬‘å¾—åƒç–¯å­ä¸€æ ·ï¼Œè·Ÿè¸ªäººç¾¤ï¼Œç©å¼„æ±¡æ°´é“ã€‚é‚£å®¶ä¼™ä¾ç„¶ä»¤äººæ¯›éª¨æ‚šç„¶åˆæ¶å¿ƒã€‚ç°åœ¨ï¼Œä»–èº«ä¸Šè¿˜æœ‰å‘³é“ï¼â€" 
            },
            { 
                name: "å››åˆ†å«", hp: "2", type: "ç–¾è¡Œå°¸", expansion: "é‡å¯å¥—è£…",
                image: "../images/American-Football-Player-z2.webp", 
                ability: "-å®ƒä¼šæ²¿ä¸€æ¡ç›´çº¿ç§»åŠ¨ç›´è‡³æ’åˆ°éšœç¢ç‰©ï¼ˆå¢™å£ã€å¹¸å­˜è€…ï¼‰ï¼Œå®ƒä¼šæ’å€’åœæ­¢åŒºåŸŸçš„æ‰€æœ‰å¹¸å­˜è€…ã€‚<br>-è¢«æ’åˆ°çš„å¹¸å­˜è€…éœ€èŠ±è´¹ä¸€ä¸ªè¡ŒåŠ¨ç‚¹ç«™èµ·ã€‚<br>-éœ€è¦ä¸¤ç‚¹ä¼¤å®³åŠä»¥ä¸Šçš„æ­¦å™¨æ‰èƒ½æ€æ­»ã€‚", 
                flavor: "â€œè¶´ä¸‹ï¼é¢„å¤‡ï¼å¼€çƒï¼è¿™ä½é€‰ç§€çŠ¶å…ƒæ­£å€¼æ¯”èµ›ä¸­é€”è¢«ä¸€åä¸§å°¸è¢­å‡»ã€‚å°½ç®¡åœ¨çªè¢­ä¸­è¢«å’¬ä¼¤ï¼Œè¿™ä½æ˜æ˜Ÿå››åˆ†å«ä»å†²åˆºè¾¾é˜µ78ç ï¼Œå¹¶åœ¨åº†ç¥æ—¶åƒæ‰äº†åŠä¸ªä¹é˜Ÿæˆå‘˜ã€ä¸¤åå•¦å•¦é˜Ÿå‘˜å’Œä¸€åæ°´æ‰‹ã€‚è‡³å°‘ä»–èµ¢äº†è®©åˆ†ç›˜ã€‚â€" 
            },
            { 
                name: "æ–°å¨˜", hp: "1", type: "ç‰¹æ®Šè¡Œå°¸", expansion: "æ¯æ—¥ä¸§å°¸", 
                image: "../images/Bride.webp", 
                ability: "<b>ã€Witch æœºåˆ¶ã€‘</b><br>- <span style='color:#f1c40f'>è¢«åŠ¨ï¼š</span>ä¸ç§»åŠ¨ï¼Œä¸æ”»å‡»ï¼Œè§†ä¸ºå™ªéŸ³æºã€‚<br>- <span style='color:#ff3838'>æš´æ€’ï¼š</span>è‹¥å—åˆ°æ”»å‡»æœªæ­»æˆ–ç©å®¶è¿›å…¥åŒæ ¼ï¼Œç«‹å³é€ æˆ2ç‚¹ä¼¤å®³å¹¶è·å¾—3æ¬¡è¡ŒåŠ¨åŠ›ã€‚", 
                flavor: "â€œé‚£çœŸæ˜¯ä¸€åœºå®Œç¾çš„å©šç¤¼ã€‚å¤©æ°”æ™´æœ—ï¼ŒèŠ±è‰ºæƒŠè‰³ï¼Œä¹é˜Ÿæ¼”å¥æ°åˆ°å¥½å¤„ï¼Œé£Ÿç‰©ä¹Ÿç¾å‘³è‡³æâ€”â€”ç›´åˆ°æ–°å¨˜å’¬æ‰äº†æ–°éƒçš„é¼»å­ã€‚é‚£ä¸€åˆ»ï¼Œå¯ä»¥è¯´èœœæœˆè¿˜æ²¡å¼€å§‹å°±ç»“æŸäº†ã€‚â€" 
            },
            { 
                name: "ç¦ç‘æ§", hp: "2", type: "ç¡•å°¸", expansion: "é‡å¯å¥—è£…",
                image: "../images/Unicorn-Girl.webp", 
                ability: "å‡»æ€ç¦ç‘æ§çš„ç©å®¶éœ€é€‰æ‹©ä¸€ä¸ªå…½ç±»ä½œä¸ºå…¶å…½è®¾ã€‚", 
                flavor: "â€œå¥¹ä»ä¸åœ¨ä¹åˆ«äººæ€ä¹ˆçœ‹å¥¹ã€‚å¥¹å–œæ¬¢ç‹¬è§’å…½ï¼Œæƒ³æˆä¸ºç‹¬è§’å…½ï¼Œå¤©å“ªï¼Œå¥¹ä¼šç©¿å¥¹é‚£ä»¶åä¸½çš„ç‹¬è§’å…½è¿ä½“è¡£ï¼Œæ— è®ºåœ¨å“ªé‡Œã€‚å‹è°Šä¸ä¼šå› ä¸ºä½ æ˜¯åƒµå°¸è€Œå¤±å»é­”åŠ›ã€‚â€" 
            },
            { 
                name: "ç¥ç§˜ç™½è¡£å¥³å­", hp: "3", type: "æœªåˆ†çº§", expansion: "è§å±±ä¸­å­¦",
                image: "../images/fjq.png", 
                ability: "-æ‰€æœ‰ç©å®¶åªèƒ½ç”¨è‹±æ–‡äº¤æµã€‚<br>-ç¥ç§˜ç™½è¡£å¥³å­åœ¨åœºæ—¶ï¼Œå—åˆ°ä¼¤å®³çš„ç©å®¶éœ€å¼ƒç½®èƒŒåŒ…çš„æ‰€æœ‰ç‰©å“ã€‚<br>-æ­»äº¡æ—¶ï¼Œåœ¨æ‰€åœ¨åŒºåŸŸå¬å”¤ç¥ç§˜çº¢è¡£å¥³å­ï¼Œè‹¥åè€…å·²åœ¨åœºåˆ™ç«‹å³æ‰§è¡Œä¸€ä¸ªè¡ŒåŠ¨ã€‚", 
                flavor: "-â€œä½ æˆ‘å§å¦¹é½ä¸Šï¼Œç„‰æœ‰ä¸€åˆä¹‹å°†ï¼â€-â€œå§å§è¯´çš„åœ¨ç†ï¼â€" 
            },
            { 
                name: "ç¥ç§˜çº¢è¡£å¥³å­", hp: "3", type: "æœªåˆ†çº§", expansion: "è§å±±ä¸­å­¦",
                image: "../images/qwe.png", 
                ability: "-æ‰€æœ‰ç©å®¶æ— æ³•ä½¿ç”¨è¯­è¨€äº¤æµã€‚<br>-è¡ŒåŠ¨ä¸¤æ¬¡ï¼Œä¼šç›´æ¥ç¬ç§»åˆ°å¹¸å­˜è€…æœ€å°‘ï¼ˆè‡³å°‘ä¸º1ï¼‰çš„åŒºåŸŸã€‚<br>-æ­»äº¡æ—¶ï¼Œåœ¨æ‰€åœ¨åŒºåŸŸå¬å”¤ç¥ç§˜ç™½è¡£å¥³å­ï¼Œè‹¥åè€…å·²åœ¨åœºåˆ™ç«‹å³æ‰§è¡Œä¸€ä¸ªè¡ŒåŠ¨ã€‚",
                flavor: "-â€œä½ æˆ‘å§å¦¹é½ä¸Šï¼Œç„‰æœ‰ä¸€åˆä¹‹å°†ï¼â€-â€œå§å§è¯´çš„åœ¨ç†ï¼â€" 
            },
        ];

        // å˜é‡åˆå§‹åŒ–
        const allExpansions = [...new Set(deckData.map(card => card.expansion))];
        let activeExpansions = new Set(allExpansions);
        
        let filteredDeck = [];
        let drawPile = [];
        
        let pendingCard = null;
        let pendingCardIndex = -1;
        let rarityType = 'common';
        let isMuted = false;
        
        // ğŸš¨ å…³é”®çŠ¶æ€é”
        let isProcessing = false; 
        let isFlipped = false;

        // éŸ³é¢‘ç¼“å­˜
        const audioCache = {}; 
        const audioMap = { 
            'common': '../audio/common.mp3', 
            'rare': '../audio/rare.mp3', 
            'epic': '../audio/epic.mp3', 
            'legendary': '../audio/legendary.mp3', 
            'golden': '../audio/golden.mp3' 
        };

        const wrapper = document.getElementById('interactionWrapper');
        const cardElement = document.getElementById('gameCard');
        const returnBtn = document.getElementById('returnBtn');
        const mainReshuffleBtn = document.getElementById('mainReshuffleBtn');
        const deckCounter = document.getElementById('deckCounter');
        const burstLayer = document.getElementById('burstLayer'); 
        const soundToggle = document.getElementById('soundToggle');
        const filterMenu = document.getElementById('filterMenu');

        const imgEl = document.getElementById('cardImage');
        const nameEl = document.getElementById('infoName');
        const hpEl = document.getElementById('infoHp');
        const typeEl = document.getElementById('infoType');
        const abilityEl = document.getElementById('infoAbility');
        const flavorEl = document.getElementById('infoFlavor');

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            initFilterMenu();
            manualReshuffle();
            
            // ğŸš€ é¢„åŠ è½½èµ„æº (ä¿®å¤å»¶è¿Ÿé—®é¢˜)
            preloadImages();
            preloadAudio();
        });

        // ç»‘å®šæ´—ç‰Œ
        mainReshuffleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            manualReshuffle();
        });

        // éŸ³æ•ˆå¼€å…³
        soundToggle.addEventListener('click', () => {
            isMuted = !isMuted;
            soundToggle.classList.toggle('muted', isMuted);
        });

        // åˆå§‹åŒ–èœå•
        function initFilterMenu() {
            allExpansions.forEach(exp => {
                const label = document.createElement('label');
                label.className = 'filter-item';
                label.innerHTML = `
                    <input type="checkbox" class="filter-checkbox" value="${exp}" checked>
                    ${exp}
                `;
                label.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) activeExpansions.add(exp);
                    else {
                        if (activeExpansions.size === 1 && activeExpansions.has(exp)) {
                            e.target.checked = true; alert("è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ‰©å±•åŒ…ï¼"); return;
                        }
                        activeExpansions.delete(exp);
                    }
                    manualReshuffle();
                });
                filterMenu.appendChild(label);
            });
        }

        // ğŸš€ å›¾ç‰‡é¢„åŠ è½½å‡½æ•°
        function preloadImages() {
            console.log("å¼€å§‹é¢„åŠ è½½å›¾ç‰‡...");
            deckData.forEach(card => {
                const img = new Image();
                img.src = card.image;
            });
        }

        // ğŸš€ éŸ³é¢‘é¢„åŠ è½½å‡½æ•°
        function preloadAudio() {
            console.log("å¼€å§‹é¢„åŠ è½½éŸ³é¢‘...");
            for (let key in audioMap) {
                const audio = new Audio();
                audio.src = audioMap[key];
                audio.preload = 'auto';
                audio.load();
                audioCache[key] = audio;
            }
        }

        // æ‰‹åŠ¨æ´—ç‰Œ
        function manualReshuffle() {
            filteredDeck = deckData.filter(card => activeExpansions.has(card.expansion));
            drawPile = [...filteredDeck];
            console.log("Deck Reset. Count:", drawPile.length);
            
            // é‡ç½®çŠ¶æ€
            isFlipped = false;
            isProcessing = false;
            cardElement.classList.remove('is-flipped');
            wrapper.classList.remove('active');
            
            // å‡†å¤‡ç¬¬ä¸€å¼ 
            prepareNextCard();
        }

        // å‡†å¤‡ä¸‹ä¸€å¼ 
        function prepareNextCard() {
            updateCounter();

            if (drawPile.length === 0) {
                cardElement.classList.add('is-empty');
                cardElement.setAttribute('data-rarity', 'empty');
                pendingCard = null;
                return;
            }

            cardElement.classList.remove('is-empty');

            // ä»…ä»…ä¸ºäº†è®¾ç½®èƒŒé¢çš„å…‰æ•ˆé¢œè‰²ï¼Œæ­¤æ—¶ä¸å†³å®šå…·ä½“æŠ½å“ªå¼ 
            const peekIndex = Math.floor(Math.random() * drawPile.length);
            const peekCard = drawPile[peekIndex];
            setRarityColor(peekCard);
        }

        // è®¾ç½®å…‰æ•ˆè¾…åŠ©å‡½æ•°
        function setRarityColor(card) {
            rarityType = 'common';
            const typeStr = card.type || "";
            if (typeStr.includes('æœªåˆ†çº§')) rarityType = 'golden';
            else if (typeStr.includes('æ†æ¶')) rarityType = 'legendary';
            else if (typeStr.includes('ç¡•')) rarityType = 'epic';
            else if (typeStr.includes('ç–¾è¡Œ')) rarityType = 'rare';
            else rarityType = 'common';
            
            cardElement.setAttribute('data-rarity', rarityType);
            burstLayer.style.setProperty('--rarity-color', getComputedStyle(document.documentElement).getPropertyValue(`--color-${rarityType}`));
        }

        // === æ ¸å¿ƒï¼šç‚¹å‡»æŠ½å¡ (å¸¦ä¸¥æ ¼é˜²æŠ–é”) ===
        cardElement.addEventListener('click', function(e) {
            // 1. ä¸¥æ ¼æ£€æŸ¥çŠ¶æ€
            if (isFlipped || isProcessing || drawPile.length === 0) return;
            
            // 2. ä¸Šé”
            isProcessing = true;

            // 3. æ­£å¼æŠ½å–ï¼šéšæœºé€‰ä¸€å¼ 
            const finalIndex = Math.floor(Math.random() * drawPile.length);
            const finalCard = drawPile[finalIndex];
            
            // 4. ä»æ•°ç»„ç§»é™¤ (Splice)
            drawPile.splice(finalIndex, 1);
            
            // 5. æ¸²æŸ“å†…å®¹
            revealCard(finalCard);
            setRarityColor(finalCard); // ç¡®ä¿ç¿»å¼€çš„å…‰æ•ˆå’Œå¡ç‰Œä¸€è‡´
            
            // 6. ç¿»è½¬åŠ¨ç”»
            cardElement.classList.add('is-flipped');
            wrapper.classList.add('active'); 
            
            triggerBurst();
            setTimeout(() => playRaritySound(rarityType), 200);
            
            isFlipped = true;
            isProcessing = false; // è§£é”
            
            // 7. ç«‹å³æ›´æ–°è®¡æ•°å™¨ (è®©ç”¨æˆ·çœ‹åˆ°å°‘äº†1å¼ )
            updateCounter();
        });

        // === è¿”å›æŒ‰é’® (å¸¦é˜²æŠ–é”) ===
        returnBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            
            if (!isFlipped || isProcessing) return;
            isProcessing = true;

            cardElement.classList.remove('is-flipped');
            wrapper.classList.remove('active'); 
            
            // ç­‰ç¿»è½¬åŠ¨ç”»ç»“æŸå†å…è®¸ä¸‹ä¸€æ¬¡ç‚¹å‡»
            setTimeout(() => {
                isFlipped = false;
                isProcessing = false;
                prepareNextCard();
            }, 600);
        });

        // ğŸ–¼ï¸ ä¿®å¤ç‰ˆ revealCard (è§£å†³æ®‹å½±é—®é¢˜)
        function revealCard(card) {
            // 1. å…ˆæŠŠå›¾ç‰‡éšè—
            imgEl.style.opacity = '0';
            imgEl.style.transition = 'opacity 0.2s'; 

            // 2. è®¾ç½®æ–°å›¾ç‰‡æº
            imgEl.src = card.image;

            // 3. ç›‘å¬ï¼šç­‰å›¾ç‰‡åŠ è½½å¥½å†æ˜¾ç¤º
            imgEl.onload = () => {
                imgEl.style.opacity = '1';
            };
            
            imgEl.onerror = () => {
                imgEl.src = 'https://via.placeholder.com/400x600?text=No+Image';
                imgEl.style.opacity = '1';
            };

            nameEl.innerText = card.name;
            hpEl.innerText = card.hp; 
            typeEl.innerText = card.type;
            abilityEl.innerHTML = `<div style="color:#f1c40f; font-size:0.9em; margin-bottom:8px;">èƒ½åŠ›ï¼š</div>${card.ability}`;
            flavorEl.innerHTML = card.flavor;
        }

        function updateCounter() {
            // æ˜¾ç¤ºï¼šå‰©ä½™å¼ æ•° / æ€»æ•°
            deckCounter.innerText = `${drawPile.length}/${filteredDeck.length}`;
        }

        function triggerBurst() {
            const colorVar = getComputedStyle(document.documentElement).getPropertyValue(`--color-${rarityType}`);
            burstLayer.style.setProperty('--rarity-color', colorVar);
            burstLayer.classList.remove('active');
            void burstLayer.offsetWidth; 
            burstLayer.classList.add('active');
        }

        // ğŸµ ä¿®å¤ç‰ˆæ’­æ”¾å‡½æ•° (ä½¿ç”¨ç¼“å­˜)
        function playRaritySound(rarity) {
            if (isMuted) return;

            // ç›´æ¥ä»ç¼“å­˜é‡Œæ‹¿
            const audio = audioCache[rarity];

            if (audio) {
                audio.currentTime = 0; 
                audio.volume = 0.8;
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => { console.log("Audio play prevented:", error); });
                }
            }
        }
    </script>
</body>
</html>